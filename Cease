---====== Load spawner ======---
local spawner = loadstring(game:HttpGet("https://raw.githubusercontent.com/RegularVynixu/Utilities/main/Doors/Entity%20Spawner/V2/Source.lua"))()

---====== Create entity ======---
local entity = spawner.Create({
	Entity = {
		Name = "Cease",
		Asset = "rbxassetid://118662290534983",
		HeightOffset = 0
	},
	Lights = {
		Flicker = { Enabled = false, Duration = 7 },
		Shatter = false,
		Repair = false
	},
	Earthquake = { Enabled = false },
	CameraShake = {
		Enabled = true,
		Range = 100,
		Values = {3, 3, 2, 2}
	},
	Movement = {
		Speed = 60,
		Delay = 0,
		Reversed = false
	},
	Rebounding = { Enabled = false },
	Damage = { Enabled = false },
	Crucifixion = {
		Enabled = true,
		Range = 40,
		Resist = false,
		Break = true
	},
	Death = {
		Type = "Guiding",
		Hints = {
			"Bạn đã chết bởi Cease.",
			"Khi Cease xuất hiện, đừng di chuyển nếu không bạn sẽ chết."
		},
		Cause = "Cease"
	}
})

---====== On Spawn ======---
entity:SetCallback("OnSpawned", function()
	print("Cease đã xuất hiện")

	local TweenService = game:GetService("TweenService")
	local Tweeninfo = TweenInfo.new(4, Enum.EasingStyle.Linear, Enum.EasingDirection.Out)
	local spawnColor = {Color = Color3.new(0, 0, 255)}

	for _, v in pairs(workspace.CurrentRooms[game.ReplicatedStorage.GameData.LatestRoom.Value]:GetDescendants()) do
		if v:IsA("Light") then
			TweenService:Create(v, Tweeninfo, spawnColor):Play()
		elseif v.Parent and v.Parent.Name == "LightFixture" then
			TweenService:Create(v.Parent, Tweeninfo, spawnColor):Play()
		end
	end

	-- === BẮT ĐẦU KIỂM TRA DI CHUYỂN CHUẨN XÁC === --
	local Players = game:GetService("Players")
	local RunService = game:GetService("RunService")

	-- đảm bảo Cease chính xác có model
	repeat task.wait() until entity.Model
	local ceaseModel = entity.Model

	local hitboxRange = 120

	local params = RaycastParams.new()
	params.FilterType = Enum.RaycastFilterType.Blacklist
	params.FilterDescendantsInstances = {ceaseModel}

	local raycastLoop
	raycastLoop = RunService.Heartbeat:Connect(function()
		local origin = ceaseModel:GetPivot().Position

		for _, player in ipairs(Players:GetPlayers()) do
			local chr = player.Character
			if chr and chr:FindFirstChild("HumanoidRootPart") and chr:FindFirstChild("Humanoid") then
				
				local hrp = chr.HumanoidRootPart
				local humanoid = chr.Humanoid
				
				-- Raycast
				local direction = (hrp.Position - origin).Unit
				local rayResult = workspace:Raycast(origin, direction * hitboxRange, params)

				if rayResult and rayResult.Instance and rayResult.Instance:IsDescendantOf(chr) then

					-- KIỂM TRA DI CHUYỂN CHUẨN
					local isMovingByInput = humanoid.MoveDirection.Magnitude > 0.1
					local isMovingByVelocity = hrp.AssemblyLinearVelocity.Magnitude > 2

					-- Chỉ giết khi cả hai đều đúng
					if isMovingByInput and isMovingByVelocity then
						humanoid.Health = 0
						print(player.Name .. " bị Cease giết vì di chuyển!")

						-- đánh dấu nguyên nhân chết
						local statsFolder = game.ReplicatedStorage:FindFirstChild("GameStats")
						if statsFolder then
							local playerStats = statsFolder:FindFirstChild("Player_" .. player.Name)
							if playerStats and playerStats:FindFirstChild("Total") and playerStats.Total:FindFirstChild("DeathCause") then
								playerStats.Total.DeathCause.Value = "Cease"
							end
						end
					end
				end
			end
		end
	end)

	---====== On Despawn ======---
	entity:SetCallback("OnDespawned", function()
		print("Cease đã biến mất")

		if raycastLoop then
			raycastLoop:Disconnect()
		end

		-- Hiệu ứng ánh sáng khi biến mất
		local Tweeninfo2 = TweenInfo.new(4, Enum.EasingStyle.Linear, Enum.EasingDirection.Out)
		local despawnColor = {Color = Color3.new(1, 0, 1)}

		for _, v in pairs(workspace.CurrentRooms[game.ReplicatedStorage.GameData.LatestRoom.Value]:GetDescendants()) do
			if v:IsA("Light") then
				TweenService:Create(v, Tweeninfo2, despawnColor):Play()
			elseif v.Parent and v.Parent.Name == "LightFixture" then
				TweenService:Create(v.Parent, Tweeninfo2, despawnColor):Play()
			end
		end

		-- Achievement
		local achievementGiver = loadstring(game:HttpGet("https://raw.githubusercontent.com/Idk-lol2/a-60aa/refs/heads/main/fix%20bage.txt"))()
		achievementGiver({
			Title = "Get out of the way",
			Desc = "Where is it?",
			Reason = "Encounter Cease",
			Image = "rbxassetid://104367200417966"
		})
	end)
end)

---====== Damage Callback ======---
entity:SetCallback("OnDamagePlayer", function(newHealth)
	if newHealth == 0 then
		print("Cease đã giết người chơi")
	else
		print("Cease gây sát thương")
	end
end)

---====== Run entity ======---
entity:Run()
